name: CI

on:
  push:
    branches:
      - master
      - main
  pull_request:

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      # 1. コードを取得
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. OCaml環境セットアップ (バージョンはDockerfileに合わせて5.2)
      - name: Use OCaml 5.2
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: 5.2.x

      # 3. 依存ライブラリのインストール
      # --with-test をつけることで、テストに必要なライブラリも入ります
      - name: Install dependencies
        run: |
          opam update
          opam install . --deps-only --with-test

      # 4. ビルド実行 (dune build)
      - name: Build
        run: opam exec -- dune build

      # 5. テスト実行 (dune runtest)
      # テストコードを書いていなくても、とりあえず実行して問題ありません
      - name: Test
        run: opam exec -- dune runtest